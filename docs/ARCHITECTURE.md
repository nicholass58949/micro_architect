# NPU微架构详细设计

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          NPU Top Module                          │
│                                                                   │
│  ┌────────────────┐                    ┌──────────────────┐     │
│  │  AXI4-Lite     │◄──────────────────►│  Control Unit    │     │
│  │  Interface     │                    │  (State Machine) │     │
│  └────────┬───────┘                    └────────┬─────────┘     │
│           │                                     │               │
│           │ Write                               │ Control       │
│           ▼                                     ▼               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Input Buffer   │  │  Weight Buffer  │  │  Output Buffer  │ │
│  │   (256x16bit)   │  │  (1024x16bit)   │  │   (256x16bit)   │ │
│  └────────┬────────┘  └────────┬────────┘  └────────▲────────┘ │
│           │                    │                     │          │
│           │ Read               │ Read                │ Write    │
│           ▼                    ▼                     │          │
│  ┌──────────────────────────────────────────────────┴────────┐ │
│  │         Matrix Multiply Unit (8x8 PE Array)              │ │
│  │                                                            │ │
│  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ │ │
│  │  │ PE │→│ PE │→│ PE │→│ PE │→│ PE │→│ PE │→│ PE │→│ PE │ │ │
│  │  └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ │ │
│  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ │ │
│  │  │ PE │→│ PE │→│ PE │→│ PE │→│ PE │→│ PE │→│ PE │→│ PE │ │ │
│  │  └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ │ │
│  │    ...    (8x8 = 64 Processing Elements)    ...           │ │
│  └──────────────────────────────┬───────────────────────────┘ │
│                                  │                             │
│                                  ▼                             │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │         Activation Unit (ReLU/Sigmoid/Tanh)              │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 处理单元（PE）详细设计

```
┌─────────────────────────────────────────┐
│        Processing Element (PE)          │
│                                          │
│  Input:                                  │
│  ┌──────────┐        ┌──────────┐       │
│  │ data_in  │        │weight_in │       │
│  │ (16bit)  │        │ (16bit)  │       │
│  └─────┬────┘        └─────┬────┘       │
│        │                   │             │
│        └────────┬──────────┘             │
│                 ▼                        │
│         ┌──────────────┐                 │
│         │  Multiplier  │                 │
│         │   (16x16)    │                 │
│         └──────┬───────┘                 │
│                │                         │
│                ▼                         │
│         ┌──────────────┐                 │
│         │  Accumulator │◄───clear_acc   │
│         │   (32bit)    │                 │
│         └──────┬───────┘                 │
│                │                         │
│                ▼                         │
│  Output:                                 │
│  ┌──────────────┐  ┌──────────────┐     │
│  │  data_out    │  │   acc_out    │     │
│  │  (16bit)     │  │   (32bit)    │     │
│  └──────────────┘  └──────────────┘     │
│                                          │
│  Function: acc_out = Σ(data_in × weight) │
└─────────────────────────────────────────┘
```

## 3. 脉动阵列数据流

```
时间 t=0:
Input: [a0, a1, a2, a3, a4, a5, a6, a7]
       ↓
    ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐
    │w00 │→ │w01 │→ │w02 │→ │w03 │→ │w04 │→ │w05 │→ │w06 │→ │w07 │
    └────┘  └────┘  └────┘  └────┘  └────┘  └────┘  └────┘  └────┘
    ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐
    │w10 │→ │w11 │→ │w12 │→ │w13 │→ │w14 │→ │w15 │→ │w16 │→ │w17 │
    └────┘  └────┘  └────┘  └────┘  └────┘  └────┘  └────┘  └────┘
    ...
    
时间 t=1:
    a0 进入第一行第一个PE，与w00相乘
    
时间 t=2:
    a0 移动到第一行第二个PE，与w01相乘
    a1 进入第一行第一个PE，与w00相乘
    
时间 t=8:
    第一行所有PE都完成累加
    输出结果：y0 = a0*w00 + a1*w01 + ... + a7*w07
```

## 4. 控制单元状态机

```
                    ┌──────┐
                    │ IDLE │
                    └───┬──┘
                        │ start
                        ▼
                 ┌─────────────┐
                 │ LOAD_CONFIG │
                 └──────┬──────┘
                        │
                        ▼
                 ┌─────────────┐
                 │ LOAD_DATA   │
                 └──────┬──────┘
                        │
                        ▼
                 ┌─────────────┐
                 │  COMPUTE    │◄──┐
                 └──────┬──────┘   │
                        │          │ not done
                        │ done     │
                        ▼          │
                 ┌─────────────┐   │
                 │  ACTIVATE   │───┘
                 └──────┬──────┘
                        │
                        ▼
                 ┌─────────────┐
                 │ WRITE_BACK  │
                 └──────┬──────┘
                        │
                        ▼
                 ┌─────────────┐
                 │ DONE_STATE  │
                 └──────┬──────┘
                        │
                        └──────► IDLE
                        
                    (error) ──► ERROR_STATE
```

## 5. AXI4-Lite接口时序

### 写操作时序
```
Clock:     ___┌─┐_┌─┐_┌─┐_┌─┐_┌─┐_┌─┐___
AWVALID:   ___┌───────┐_______________
AWREADY:   _______┌───┐_______________
AWADDR:    ───<ADDR>──────────────────
WVALID:    ___┌───────┐_______________
WREADY:    _______┌───┐_______________
WDATA:     ───<DATA>──────────────────
BVALID:    ___________┌───────┐_______
BREADY:    ___________┌───────┐_______
```

### 读操作时序
```
Clock:     ___┌─┐_┌─┐_┌─┐_┌─┐_┌─┐_┌─┐___
ARVALID:   ___┌───────┐_______________
ARREADY:   _______┌───┐_______________
ARADDR:    ───<ADDR>──────────────────
RVALID:    ___________┌───────┐_______
RREADY:    ___________┌───────┐_______
RDATA:     ───────────<DATA>──────────
```

## 6. 寄存器映射

```
地址范围              | 功能                | 访问类型
---------------------|---------------------|----------
0x0000 - 0x000F      | 控制和状态寄存器     | RW/RO
  0x0000             |   CTRL_REG          | RW
  0x0004             |   STATUS_REG        | RO
  0x0008             |   CONFIG_REG        | RW
  0x000C             |   INT_STATUS        | RW1C
---------------------|---------------------|----------
0x0100 - 0x01FF      | 权重存储区          | WO
  256 bytes          |   (64 x 16bit)      |
---------------------|---------------------|----------
0x0200 - 0x02FF      | 输入数据区          | WO
  256 bytes          |   (128 x 16bit)     |
---------------------|---------------------|----------
0x0300 - 0x03FF      | 输出数据区          | RO
  256 bytes          |   (128 x 16bit)     |
---------------------|---------------------|----------
```

### 寄存器详细定义

#### CTRL_REG (0x0000)
```
Bit    | 名称      | 访问  | 描述
-------|-----------|-------|---------------------------
[0]    | RESET     | RW    | 软复位（写1复位，自动清零）
[1]    | START     | RW    | 启动计算（写1启动）
[31:2] | Reserved  | -     | 保留
```

#### STATUS_REG (0x0004)
```
Bit    | 名称      | 访问  | 描述
-------|-----------|-------|---------------------------
[0]    | BUSY      | RO    | 忙标志（1=计算中）
[1]    | DONE      | RO    | 完成标志（1=已完成）
[2]    | ERROR     | RO    | 错误标志（1=有错误）
[5:3]  | STATE     | RO    | 当前状态（用于调试）
[31:6] | Reserved  | -     | 保留
```

#### CONFIG_REG (0x0008)
```
Bit    | 名称      | 访问  | 描述
-------|-----------|-------|---------------------------
[7:0]  | MATRIX_SIZE| RW   | 矩阵大小（1-8）
[9:8]  | ACT_TYPE  | RW    | 激活函数类型
       |           |       |   00: None
       |           |       |   01: ReLU
       |           |       |   10: Sigmoid
       |           |       |   11: Tanh
[31:10]| Reserved  | -     | 保留
```

#### INT_STATUS (0x000C)
```
Bit    | 名称      | 访问  | 描述
-------|-----------|-------|---------------------------
[0]    | DONE_INT  | RW1C  | 计算完成中断（写1清除）
[1]    | ERROR_INT | RW1C  | 错误中断（写1清除）
[31:2] | Reserved  | -     | 保留
```

## 7. 数据格式

### Q8.8定点数格式
```
15 14 13 12 11 10  9  8 | 7  6  5  4  3  2  1  0
 S  I  I  I  I  I  I  I | F  F  F  F  F  F  F  F
 │  └──────整数部分──────┘ └──────小数部分──────┘
 └─ 符号位（0=正，1=负）

示例：
0x0100 = 0000_0001.0000_0000 = 1.0
0x0080 = 0000_0000.1000_0000 = 0.5
0x0200 = 0000_0010.0000_0000 = 2.0
0xFF80 = 1111_1111.1000_0000 = -0.5
```

### 定点乘法
```
Q8.8 × Q8.8 = Q16.16

例如：
  1.5 × 2.0
= 0x0180 × 0x0200
= 0x0003_0000 (Q16.16)
= 0x0300 (右移8位，恢复到Q8.8)
= 3.0
```

## 8. 性能分析

### 计算吞吐量
```
PE数量：8 × 8 = 64个
每个PE每周期：1次MAC运算
总吞吐量：64 MAC/周期

时钟频率：100MHz
峰值性能：64 × 100M = 6.4 GMAC/s
         = 12.8 GOPS（考虑乘法和加法）
```

### 延迟分析
```
8×8矩阵乘法延迟：
- 数据加载：2周期
- 矩阵计算：8周期（矩阵维度）
- 激活函数：1周期
- 数据写回：2周期
总延迟：约13周期

在100MHz下：130ns
```

### 带宽需求
```
输入数据：8 × 16bit = 128bit
权重数据：64 × 16bit = 1024bit
输出数据：8 × 16bit = 128bit

每次计算总数据量：1280bit = 160字节
带宽需求：160B / 130ns ≈ 1.23 GB/s
```

## 9. 资源估计（Xilinx 7系列FPGA）

```
资源类型    | 数量估计  | 说明
-----------|----------|---------------------------
LUT        | ~5000    | 组合逻辑
FF         | ~3000    | 寄存器
DSP48      | 64       | MAC运算（每个PE一个）
BRAM 36Kb  | 4-6      | 缓存（输入/权重/输出）
最大频率    | 100-150MHz| 取决于布局布线
功耗       | ~1-2W    | 动态功耗估计
```

## 10. 扩展方向

### 短期优化
1. 完善数据路径连接逻辑
2. 添加FIFO缓冲
3. 支持分块矩阵计算
4. 优化时序（流水线）

### 中期扩展
1. 添加卷积专用硬件
2. 支持池化操作
3. 添加DMA控制器
4. 支持INT8量化

### 长期目标
1. 多层网络自动执行
2. 稀疏矩阵优化
3. 混合精度支持
4. 完整SoC集成

---

**注意**：本文档描述的是教学用NPU架构，实际商用NPU会更加复杂，包含更多优化和功能。
