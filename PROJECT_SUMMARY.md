# NPU微架构项目总结

## 项目概述

本项目实现了一个完整的NPU（神经网络处理单元）微架构，用于学习和理解硬件加速器的设计原理。该NPU采用脉动阵列架构，支持矩阵乘法和多种激活函数，通过标准AXI4-Lite接口与系统集成。

## 项目统计

### 代码规模
- **Verilog源文件**：9个模块
- **总代码行数**：约2300行（含注释）
- **测试代码**：1个完整测试平台
- **文档**：5个详细文档

### 文件清单

#### RTL源代码（rtl/）
1. `processing_element.v` (150行) - 处理单元，执行MAC运算
2. `matrix_multiply_unit.v` (300行) - 矩阵乘法单元，8×8 PE阵列
3. `activation_unit.v` (250行) - 激活函数单元（ReLU/Sigmoid/Tanh）
4. `input_buffer.v` (100行) - 输入数据缓存
5. `weight_buffer.v` (100行) - 权重数据缓存
6. `output_buffer.v` (100行) - 输出数据缓存
7. `control_unit.v` (250行) - 控制状态机
8. `axi_interface.v` (400行) - AXI4-Lite接口
9. `npu_top.v` (350行) - NPU顶层模块

#### 测试代码（testbench/）
1. `npu_tb.v` (300行) - 完整的测试平台

#### 文档
1. `README.md` - 项目说明和使用指南
2. `ARCHITECTURE.md` - 详细架构设计文档
3. `LEARNING_GUIDE.md` - 学习指南和教程
4. `FILELIST.md` - 文件列表和编译说明
5. `PROJECT_SUMMARY.md` - 本文档

#### 脚本
1. `run_sim.sh` - Icarus Verilog仿真脚本
2. `run_modelsim.do` - ModelSim仿真脚本

## 核心功能

### 1. 矩阵乘法加速
- **PE阵列**：8×8 = 64个处理单元
- **吞吐量**：64 MAC/周期
- **峰值性能**：6.4 GMAC/s @ 100MHz
- **架构**：脉动阵列（Systolic Array）

### 2. 激活函数
- **ReLU**：max(0, x)
- **Sigmoid**：1/(1+e^-x)，查找表实现
- **Tanh**：基于Sigmoid的近似
- **None**：直通模式

### 3. 数据缓存
- **输入缓存**：256×16bit
- **权重缓存**：1024×16bit
- **输出缓存**：256×16bit
- **类型**：双端口RAM

### 4. 系统接口
- **协议**：AXI4-Lite
- **地址宽度**：32位
- **数据宽度**：32位
- **寄存器**：4个控制/状态寄存器

## 技术特点

### 1. 数据格式
- **定点数**：Q8.8格式（8位整数 + 8位小数）
- **范围**：-128.0 到 +127.996
- **精度**：1/256 ≈ 0.0039
- **优势**：硬件简单，功耗低

### 2. 脉动阵列
- **数据流**：从左向右流动
- **权重**：固定在PE中
- **优势**：局部通信，易于扩展
- **灵感**：Google TPU架构

### 3. 控制流
- **状态机**：8个状态
- **流程**：配置→加载→计算→激活→输出
- **保护**：超时检测，错误处理
- **中断**：计算完成/错误中断

### 4. 接口设计
- **标准协议**：AXI4-Lite
- **握手机制**：valid/ready
- **寄存器映射**：清晰的地址空间
- **易于集成**：标准SoC接口

## 性能指标

### 计算性能
```
PE数量：64个
时钟频率：100MHz
峰值吞吐：6.4 GMAC/s
实际性能：约5-6 GMAC/s（考虑开销）
```

### 延迟
```
8×8矩阵乘法：约13周期
在100MHz下：130ns
包含：加载(2) + 计算(8) + 激活(1) + 写回(2)
```

### 带宽
```
每次计算数据量：160字节
带宽需求：约1.2 GB/s
片上缓存减少外部访问
```

### 资源（FPGA）
```
LUT：~5000
FF：~3000
DSP48：64
BRAM：4-6块
功耗：1-2W（估计）
```

## 学习价值

### 1. 数字电路设计
- ✅ 组合逻辑和时序逻辑
- ✅ 寄存器和状态机
- ✅ 流水线设计
- ✅ 时序约束

### 2. 计算机体系结构
- ✅ 并行计算
- ✅ 数据流架构
- ✅ 存储层次
- ✅ 总线协议

### 3. 神经网络硬件
- ✅ 矩阵乘法加速
- ✅ 激活函数实现
- ✅ 定点运算
- ✅ 数据重用

### 4. 工程实践
- ✅ 模块化设计
- ✅ 接口规范
- ✅ 测试验证
- ✅ 文档编写

## 使用方法

### 快速开始

1. **查看文档**
   ```bash
   # 阅读README了解项目
   cat README.md
   
   # 学习架构设计
   cat ARCHITECTURE.md
   
   # 跟随学习指南
   cat LEARNING_GUIDE.md
   ```

2. **运行仿真**
   ```bash
   # 使用Icarus Verilog
   bash run_sim.sh
   
   # 或使用ModelSim
   vsim -do run_modelsim.do
   ```

3. **查看波形**
   ```bash
   # 打开波形查看器
   gtkwave sim_output/npu_tb.vcd
   ```

### 测试用例

测试平台包含完整的测试流程：
1. 复位和配置NPU
2. 加载权重数据（单位矩阵）
3. 加载输入数据（全1向量）
4. 启动计算
5. 等待完成
6. 读取结果
7. 验证中断

### 预期结果

对于单位矩阵乘法测试：
```
输入：[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
权重：8×8单位矩阵
输出：[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
```

## 扩展方向

### 短期改进（1-2周）
- [ ] 完善数据路径连接逻辑
- [ ] 添加FIFO缓冲提高性能
- [ ] 支持可变矩阵大小
- [ ] 添加更多测试用例

### 中期扩展（1-2月）
- [ ] 添加卷积专用硬件
- [ ] 实现池化单元
- [ ] 添加DMA控制器
- [ ] 支持INT8量化

### 长期目标（3-6月）
- [ ] 多层网络自动执行
- [ ] 稀疏矩阵优化
- [ ] 混合精度支持
- [ ] FPGA原型验证
- [ ] 软件驱动开发

## 参考资料

### 学术论文
1. **Systolic Arrays** - H.T. Kung, 1982
   - 脉动阵列的开创性论文
   
2. **In-Datacenter Performance Analysis of a TPU** - Google, 2017
   - Google TPU架构分析
   
3. **Eyeriss: An Energy-Efficient Reconfigurable Accelerator** - MIT, 2016
   - 能效优化的NPU设计

### 技术文档
1. **AXI Protocol Specification** - ARM IHI 0022E
   - AXI协议标准
   
2. **Verilog HDL** - IEEE 1364-2005
   - Verilog语言标准

### 在线课程
1. **CS231n** - Stanford
   - 深度学习和神经网络
   
2. **Digital Design** - Coursera
   - 数字电路设计基础

## 常见问题

### Q1: 这个NPU能用于实际应用吗？
**A**: 这是一个教学项目，展示了NPU的基本原理。实际应用需要更多优化和功能扩展。

### Q2: 如何在FPGA上运行？
**A**: 需要添加约束文件，使用Vivado或Quartus进行综合和实现。建议使用Xilinx 7系列或更高版本FPGA。

### Q3: 性能如何与GPU比较？
**A**: 这个小型NPU的性能远低于现代GPU，但展示了专用加速器的设计思路。商用NPU（如Google TPU）性能可与GPU媲美。

### Q4: 可以用于训练吗？
**A**: 当前设计仅支持推理。训练需要支持反向传播和梯度更新，需要大幅扩展。

### Q5: 如何修改矩阵大小？
**A**: 修改`npu_top.v`中的`MATRIX_SIZE`参数，并相应调整缓存大小。

## 致谢

本项目受以下工作启发：
- Google TPU架构
- MIT Eyeriss项目
- Xilinx DPU设计
- 各种开源NPU项目

## 许可证

本项目仅用于教育和学习目的。

## 联系方式

如有问题或建议，欢迎交流讨论。

---

**项目创建时间**：2026年1月
**最后更新**：2026年1月
**版本**：1.0

祝学习愉快！🚀
